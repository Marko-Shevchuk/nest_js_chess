<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chess Game</title>
  <style>
      body {
          font-family: Arial, sans-serif;
          text-align: center;
      }
      h1 {
          margin-top: 20px;
      }
      p {
          margin: 10px 0;
      }
      .board {
          display: inline-block;
          margin-top: 20px;
      }
      .row {
          display: flex;
      }
      .square {
          width: 60px;
          height: 60px;
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 24px;
          cursor: pointer;
      }
      .light {
          background-color: #f0d9b5;
      }
      .dark {
          background-color: #b58863;
      }
      .selected {
          outline: 3px solid yellow;
      }
  </style>
</head>
<body>
<h1>Chess Game</h1>
<p id="message">Welcome to the Chess Game!</p>
<div id="board" class="board"></div>

<script>
  const API_BASE = 'http://localhost:3000/chess'; // Backend URL
  let selectedSquare = null;

  // Fetch and render the board
  async function fetchBoard() {
    try {
      const response = await fetch(`${API_BASE}/board`);
      const board = await response.json();
      renderBoard(board);
    } catch (error) {
      console.error('Error fetching board:', error);
    }
  }

  // Render the chessboard
  function renderBoard(board) {
    const boardElement = document.getElementById('board');
    boardElement.innerHTML = ''; // Clear previous board

    board.forEach((row, rowIndex) => {
      const rowElement = document.createElement('div');
      rowElement.classList.add('row');

      row.forEach((square, colIndex) => {
        const squareElement = document.createElement('div');
        squareElement.classList.add('square', (rowIndex + colIndex) % 2 === 0 ? 'light' : 'dark');

        if (square) {
          const pieceSymbols = {
            p: '♟',
            r: '♜',
            n: '♞',
            b: '♝',
            q: '♛',
            k: '♚',
          };
          // Render white pieces with white symbols
          squareElement.textContent = square.color === 'w'
            ? pieceSymbols[square.type].toUpperCase()
            : pieceSymbols[square.type];
          squareElement.style.color = square.color === 'w' ? 'white' : 'black';
        }

        squareElement.addEventListener('click', () => handleSquareClick(rowIndex, colIndex));
        rowElement.appendChild(squareElement);

        if (
          selectedSquare &&
          selectedSquare.row === rowIndex &&
          selectedSquare.col === colIndex
        ) {
          squareElement.classList.add('selected');
        }
      });

      boardElement.appendChild(rowElement);
    });
  }


  // Handle square click
  function handleSquareClick(row, col) {
    if (selectedSquare) {
      makeMove(selectedSquare, { row, col });
      selectedSquare = null;
    } else {
      selectedSquare = { row, col };
      fetchBoard(); // Re-render board to highlight the selected square
    }
  }

  // Make a move
  async function makeMove(from, to) {
    const fromPos = `${String.fromCharCode(97 + from.col)}${8 - from.row}`;
    const toPos = `${String.fromCharCode(97 + to.col)}${8 - to.row}`;

    try {
      const response = await fetch(`${API_BASE}/move`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ from: fromPos, to: toPos }),
      });
      const message = await response.text();
      document.getElementById('message').textContent = message;
      fetchBoard(); // Refresh board after the move
    } catch (error) {
      console.error('Error making move:', error);
      document.getElementById('message').textContent = 'Invalid move.';
    }
  }

  // Initial board fetch
  fetchBoard();
</script>
</body>
</html>
